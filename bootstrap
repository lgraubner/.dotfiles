#!/usr/bin/env bash

# catch error
trap 'ret=$?; test $ret -ne 0 && printf "\n\e[31mBootstrap script failed to complete.\033[0m\n" >&2; exit $ret' EXIT

set -e

# check for utils file
if [ -e utils ]; then
	cd "$(dirname "${BASH_SOURCE[0]}")" \
		&& . "utils"
else
	printf "\n ⚠️  ./utils not found\n"
	exit 1
fi

printf "
╭───────────────────────────────────────────────────╮
│                                                   │
│  ${bold}Lars' dotfiles${normal}                                   │
│                                                   │
│  Bootstrap script to get up and running quickly   │
│  on MacOS. Safe to run multiple times on the      │
│  same machine.                                    │
│                                                   │
│  ${dim}https://github.com/lgraubner/dotfiles${normal}            │
│                                                   │
╰───────────────────────────────────────────────────╯
"

echo_chapter "Checking internet connection"
check_internet_connection

echo_chapter "Caching password"
ask_for_sudo

echo_chapter "Installing Dependencies"

# install xcode
if type xcode-select >&- && xpath=$( xcode-select --print-path ) &&
	test -d "${xpath}" && test -x "${xpath}" ; then
	print_success_muted "Xcode already installed."
else
	echo_chapter "Installing Xcode…"
	xcode-select --install
	print_success "Xcode installed!"
fi

# create home bin
if [ ! -d "$HOME/.bin/" ]; then
	mkdir "$HOME/.bin"
fi

# install homebrew
if ! [ -x "$(command -v brew)" ]; then
	echo_install "Installing Homebrew…"
	curl -fsS 'https://raw.githubusercontent.com/Homebrew/install/master/install' | ruby
	export PATH="/usr/local/bin:$PATH"
	print_success "Homebrew installed!"
else
	print_success_muted "Homebrew already installed."
fi

# install brew formulaes
if [ -e $cwd/swag/brews ]; then
	echo_chapter "Installing Homebrew formulae"

	for brew in $(<$cwd/swag/brews); do
		install_brews $brew
	done
fi

echo_chapter "Updating Homebrew formulae"
brew update &>/dev/null
print_success "Updated"

# install brew casks
if [ -e $cwd/swag/casks ]; then
	echo "Installing apps via Homebrew"

	for cask in $(<$cwd/swag/casks); do
	    install_application_via_brew $cask
	done
fi

# brew cleanup
echo_chapter "Cleaning up Homebrew files"
brew cleanup 2> /dev/null
brew cask cleanup 2> /dev/null

print_success "Cleaned up"

# install npm packages
if [ -e $cwd/swag/npm ]; then
	echo_chapter "Installing npm packages"

  for pkg in $(<$cwd/swag/npm); do
	    install_npm_packages $pkg
	done
fi

exit 0


# Enable zsh shell
if [[ "$SHELL" != "/bin/zsh" ]]; then
  chsh -s $(which zsh)
fi

which -s brew
if [[ $? != 0 ]] ; then
  # Install homebrew
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
else
  # Make sure we're using latest Homebrew
  brew update
fi


# Install global npm packages
if [ $(which npm) ]; then
  npm install -g sitemap-generator-cli
  npm install -g svgo
  npm install -g n
  npm install -g gzip-size-cli
  npm install -g flow-typed
  npm install -g create-react-app
  npm install -g prettier
  npm install -g git-open
  npm install -g http-server
  npm install -g npm-check
  npm install -g fkill-cli
  npm install -g strong-pwgen-cli
  npm install -g spaceship-prompt
  npm install -g gatsby-cli

  # Install node versions and active stable release
  n lts
  n latest
  n stable
fi

which -s composer
if [[ $? != 0 ]]; then
  # Install composer globally
  curl -sS https://getcomposer.org/installer | sudo php -- --install-dir=/usr/local/bin --filename=composer
else
  # Make sure we're using latest version
  composer self-update
fi

cd "$(dirname "${BASH_SOURCE}")";

# Get latest dotfiles
#git pull origin master;

function copy() {
	rsync --exclude ".git/" \
		--exclude ".DS_Store" \
		--exclude "*.sh" \
		--exclude "README.md" \
		--exclude "LICENSE" \
    --exclude "fonts" \
		-avh --no-perms . ~;
    /bin/zsh -c "source ~/.zshrc"
}

if [ "$1" == "--force" -o "$1" == "-f" ]; then
	copy;
else
	read -p "This may overwrite existing files in your home directory. Are you sure? (y/n) " -n 1;
	echo "";
	if [[ $REPLY =~ ^[Yy]$ ]]; then
		copy;
	fi;
fi;
unset copy;
