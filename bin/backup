#!/usr/bin/env bash

# catch error
trap 'ret=$?; test $ret -ne 0 && printf "\n\e[31mBackup failed to complete.\033[0m\n" >&2; exit $ret' EXIT

set -e

# get device name
device=$(scutil --get ComputerName)
user=$(id -un)
backupFolder="/home/backitup/backup/${device// /_}/$user"
homeserver=backitup@192.168.2.2

# create device backup folder if it doesn't exist
ssh $homeserver mkdir -p "$backupFolder"

# rsync folders
paths=("$HOME/code" "$HOME/Downloads" "$HOME/Desktop")
for path in "${paths[@]}"; do
	echo "Backing up \"$path\"..."
  folder=$(basename "$path")
  rsync -av --delete --exclude node_modules/ --exclude vendor/ -e "ssh -i $HOME/.ssh/id_rsa" "$path/" "$homeserver:$backupFolder/$folder/"
done

# no delete option on documents
rsync -av -e "ssh -i $HOME/.ssh/id_rsa"  "$HOME/Documents" "$homeserver:$backupFolder/Documents"

echo "Done!"
